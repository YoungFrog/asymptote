%%% Asymptote style file for LaTeX
%%% Contributed by Tom Prince 14 May 2003
%%% Modified by John Bowman
%%% Adapted from comment.sty (Under GPL v2)

\newif\ifinline
\DeclareOption{inline}{\inlinetrue}
\ProcessOptions*

\ifinline
\RequirePackage{graphicx,pstricks}
\else
\RequirePackage{graphics}
\fi

\def\makeinnocent#1{\catcode`#1=12 }
\def\csarg#1#2{\expandafter#1\csname#2\endcsname}
\newwrite\AsyStream
\newread\AsyTestStream
\def\AsyFile{\jobname.asy}
\immediate\openout\AsyStream=\AsyFile
\newcounter{asy}

\def\ProcessAsymptote#1% start it all off
{\begingroup
  \def\CurrentAsymptote{#1}%
  \let\do\makeinnocent \dospecials 
  \makeinnocent\^^L% and whatever other special cases
  \endlinechar`\^^M \catcode`\^^M=12 \xAsymptote}
{\catcode`\^^M=12 \endlinechar=-1 %
  \gdef\xAsymptote{%
    \expandafter\ProcessAsymptoteLine}
  \gdef\ProcessAsymptoteLine#1^^M{\def\test{#1}
    \csarg\ifx{End\CurrentAsymptote Test}\test
    \edef\next{\noexpand\EndOfAsymptote{\CurrentAsymptote}}%
    \else \ThisAsymptote{#1}\let\next\ProcessAsymptoteLine
    \fi \next}
}

\def\ASYstringmeaning#1{\expandafter\ASYgobblearrow\meaning#1}
\def\ASYstringcsnoescape#1{\expandafter\ASYgobbleescape\string#1}
{\escapechar-1
  \expandafter\expandafter\expandafter\gdef
  \expandafter\expandafter\expandafter\ASYgobblearrow
  \expandafter\string\csname macro:->\endcsname{}
}
\def\ASYgobbleescape#1{\ifnum`\\=`#1 \else #1\fi}
\def\WriteAsyLine#1{\def\ASYtmp{#1}%
  \immediate\write\AsyStream{\ASYstringmeaning\ASYtmp}}
\def\gedefappend#1#2{%
  \toks@ = \expandafter{#1}%
  \global\edef#1{\the\toks@ #2}%
}%
\def\globalASYdefs{}
\def\WriteGlobalAsyLine#1{\def\ASYtmp{#1^^J}%
\gedefappend\globalASYdefs{\ASYstringmeaning\ASYtmp}}

\def\EndOfAsymptote#1{\endgroup\end{#1}%
    \csname After#1Asymptote\endcsname}
\def\AsymptoteEndDef#1{{\escapechar=-1\relax
    \csarg\xdef{End#1Test}{\string\\end\string\{#1\string\}}%
  }}

\def\AfterasyAsymptote{%
  \immediate\write\AsyStream{atexit(atexit);}%
  \immediate\write\AsyStream{exitfunction();}%
  \immediate\write\AsyStream{\@charrb}%
  \ifinline
  \openin\AsyTestStream=\jobname_\arabic{asy}_.tex
  \else
  \openin\AsyTestStream=\jobname_\arabic{asy}.eps
  \fi
  \ifeof\AsyTestStream
    \ifinline
      \message{File \jobname_\arabic{asy}_.tex does not exist.}%
    \else
      \message{File \jobname_\arabic{asy}.eps does not exist.}%
    \fi
    \closein\AsyTestStream%
  \else
    \closein\AsyTestStream%
    \ifinline
    \input{\jobname_\arabic{asy}_.tex}%
    \else
    \includegraphics{\jobname_\arabic{asy}.eps}%
    \fi
  \fi
  \relax%
  \endgroup}
\newcommand\ASYdefaultsize{\the\linewidth,0,Aspect}
\newcommand\asy[1][\ASYdefaultsize]{%
  \begingroup
  \let\par\empty
  \stepcounter{asy}%
  \def\@optarg{#1}%
   \immediate\write\AsyStream{\@charlb}%
   \immediate\write\AsyStream{static import plain;}%
   \immediate\write\AsyStream{defaultfilename="\jobname_\arabic{asy}";}%
  \ifx\@optarg\empty
   \immediate\write\AsyStream{size(\ASYdefaultsize);}%
  \else
    \immediate\write\AsyStream{size(#1);}%
  \fi
  \immediate\write\AsyStream{\globalASYdefs}%
  \let\ThisAsymptote\WriteAsyLine%
  \ProcessAsymptote{asy}}
\AsymptoteEndDef{asy}
\def\AfterasydefAsymptote{\relax}
\def\asydef{%
  \let\ThisAsymptote\WriteGlobalAsyLine%
  \ProcessAsymptote{asydef}}
\AsymptoteEndDef{asydef}

\AtEndDocument{\immediate\closeout\AsyStream}

\def\Asymptote{{\tt Asymptote}}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "shared"
%%% End: 
