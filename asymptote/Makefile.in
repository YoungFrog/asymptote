# @configure_input@

ARCH = unix
POLL = poll

GC = @GCDIR@
GCLIBS = @GCLIBS@
LFLAGS = @LDFLAGS@
LIBS = $(LFLAGS) @LIBS@ $(GCLIBS)

CAMP = camperror path drawpath drawlabel picture psfile texfile util settings \
       guide flatguide knot drawfill path3
FILES = $(CAMP) runtime env genv main stm dec errormsg callable name \
	symbol types entry exp newexp stack camp.tab lex.yy access \
	absyn record interact fileio builtin fftw++ simpson coder coenv \
	@getopt@ locate parser program application varinit fundec refaccess

DIST = camp.tab.h camp.tab.cc lex.yy.cc runtime.h runtime.cc
CLEAN = camp.output
NAME = asy
XNAME = x$(NAME)

CXX = @CXX@ -Wall -ansi
CC = @CC@ -Wall -ansi
MAKEDEPEND = $(OPTS) -O0 -M -DDEPEND
BISON = bison
LEX = @LEX@

DEFS = @DEFS@ @OPTIONS@
CFLAGS = @CPPFLAGS@ @CFLAGS@ 
OPTS = $(DEFS) $(CFLAGS)
INCL = -I . @INCL@

prefix = $(DESTDIR)@prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
datadir = @datadir@
asydir = $(datadir)/asymptote
docdir = $(datadir)/doc/asymptote
exampledir = $(docdir)
animationsdir = $(exampledir)/animations
latexdir = $(DESTDIR)@latexdir@
INSTALL = @INSTALL@
ASYMPTOTE_DIR = ../base

export prefix docdir exampledir mandir INSTALL ASYMPTOTE_DIR 

asy: $(FILES:=.o) $(GCLIBS)
	$(CXX) $(OPTS) -o $(NAME) $(FILES:=.o) $(LIBS)

msdos: $(FILES:=.o) asy.o $(GCLIBS)
	$(CXX) $(OPTS) -o $(NAME) $(FILES:=.o) asy.o $(LIBS) -s -static

asy.o:	asy.rc asy.ico Makefile
	cat asy.rc | sed -e "s/ASYMPTOTE_VERSION/@VERSION@/" | \
	windres -o asy.o

all:  	asy man

$(GCLIBS): $(GC).tar.gz
	gunzip -c $(GC).tar.gz > $(GC).tar
	tar -xf $(GC).tar
	rm -f $(GC).tar
	cd $(GC); \
	./configure --disable-threads --disable-shared --enable-cplusplus; \
	$(MAKE) check

doc:	asy
	cd doc; $(MAKE) doc

man:	asy
	cd doc; $(MAKE) man

runtime.cc: runtime.pl runtime.in
	./runtime.pl

camp.tab.h: camp.tab.cc

camp.tab.cc: camp.y
	$(BISON) -dvt -b camp camp.y
	mv camp.tab.c camp.tab.cc

lex.yy.cc: camp.l
	$(LEX) -d -olex.yy.cc camp.l

lex.yy.d: lex.yy.cc camp.tab.h $(GCLIBS)

install: install-asy install-man

install-all: install-asy install-doc

install-asy: asy
	${INSTALL} -d $(bindir) $(asydir) $(exampledir) $(animationsdir)
	-${INSTALL} -d $(latexdir)
	${INSTALL} -p -m 755 -s $(NAME) $(bindir)
	${INSTALL} -p -m 755 $(XNAME) $(bindir)
	${INSTALL} -p -m 644 base/*.asy $(asydir)
	${INSTALL} -p -m 644 examples/*.asy examples/piicon.eps base/asy* \
		doc/*.asy doc/*.csv doc/*.dat doc/latexusage.tex $(exampledir)
	${INSTALL} -p -m 644 examples/animations/*.asy $(animationsdir)
	-${INSTALL} -p -m 644 doc/asymptote.sty $(latexdir)
	-if test -z "$(DESTDIR)"; then \
	  texhash; \
	fi

install-doc: doc
	cd doc; $(MAKE) install

install-man: man
	cd doc; $(MAKE) install-man

uninstall: uninstall-all

uninstall-all: uninstall-man uninstall-asy

uninstall-asy:
	-cd $(animationsdir); rm -f *.asy
	-rmdir $(animationsdir)
	-cd $(exampledir); rm -f *.asy *.csv *.dat asy* piicon.eps \
		latexusage.tex
	-rmdir $(exampledir)
	-cd $(asydir); rm -f *.asy
	-rmdir $(asydir)
	-rm -f $(latexdir)/asymptote.sty
	-rmdir $(latexdir)
	-rm -f $(bindir)/$(NAME) $(bindir)/$(XNAME) 

uninstall-man: 
	cd doc; $(MAKE) uninstall

clean:  FORCE
	rm -f asy *.o *.d *mon.out $(CLEAN)

cleaner: distclean
distclean: FORCE clean
	-if test -d $(GC); then \
		$(MAKE) -C $(GC) distclean; \
		rm -rf $(GC); \
	fi
	rm -f Makefile config.h config.log config.status; \
	cd doc; $(MAKE) distclean; \

cleanest: maintainer-clean
maintainer-clean: FORCE distclean
	rm -f configure config.h.in $(DIST)
	rm -rf autom4te.cache

check: asy FORCE
	./wce
	$(MAKE) -C tests

.SUFFIXES: .c .cc .o .d
.cc.o:
	$(CXX) $(OPTS) $(INCL) -o $@ -c $<
.cc.d:
	@echo Creating $@; \
	rm -f $@; \
	${CXX} $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@.$$$$ 2>/dev/null && \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$
.c.d:
	@echo Creating $@; \
	rm -f $@; \
	${CC} $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@.$$$$ 2>/dev/null && \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$

ifeq (,$(findstring clean,${MAKECMDGOALS}))
-include $(FILES:=.d)
endif

FORCE:

configure: configure.ac
	autoheader && autoconf

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

