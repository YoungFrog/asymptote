# @configure_input@

ARCH = unix
POLL = poll

LIBS = $(LFLAGS) @LIBS@

CAMP = camperror path drawpath drawlabel picture psfile texfile util settings \
       guide knotlist pathlist drawfill
FILES = $(CAMP) cast env genv main runtime stm dec errormsg inst name symbol \
	types entry exp newexp stack camp.tab lex.yy import access @getopt@ \
	absyn record pool interact fileio builtin fftw++ simpson coder coenv
CLEAN = camp.tab.h camp.tab.cc lex.yy.cc camp.output
NAME = asy
XNAME = x$(NAME)

CXX = @CXX@ -Wall -ansi
MAKEDEPEND = $(OPTS) -M -DDEPEND
BISON = @BISON@
LEX = @LEX@

DEFS = @DEFS@
CFLAGS = @CFLAGS@
OPTS = $(DEFS) $(CFLAGS) 
INCL = -I- -I .

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
datadir = @datadir@
asydir = $(datadir)/asymptote
exampledir = $(datadir)/doc/asymptote
latexdir = @latexdir@
INSTALL = @INSTALL@
ASYMPTOTE_DIR = ../base

export prefix exampledir mandir INSTALL ASYMPTOTE_DIR 

# $(MAGIC) is here for when we include Makefile again from Compile
asy$(MAGIC): depend
	$(MAKE) -f Compile asy

all:  	asy man

man:	asy
	cd doc; $(MAKE) man

depend: parser $(FILES:=.d)

parser: camp.tab.cc camp.tab.h lex.yy.cc

camp.tab.h: camp.tab.cc

camp.tab.cc: camp.y
	$(BISON) -dvt -b camp camp.y
	mv camp.tab.c camp.tab.cc

lex.yy.cc: camp.l
	$(LEX) -d -olex.yy.cc camp.l

lex.yy.d: lex.yy.cc camp.tab.h

install: install-all

install-all: install-asy install-man

install-asy: asy
	${INSTALL} -d $(bindir) $(asydir) $(exampledir) $(latexdir)
	${INSTALL} -s $(NAME) $(bindir)
	${INSTALL} $(XNAME) $(bindir)
	${INSTALL} -m644 base/*.asy $(asydir)
	${INSTALL} -m644 examples/*.asy base/asy* $(exampledir)
	${INSTALL} -m644 doc/asymptote.sty $(latexdir)
	texhash

install-man: man
	cd doc; $(MAKE) install

uninstall: uninstall-all

uninstall-all: uninstall-man uninstall-asy

uninstall-asy:
	-cd $(exampledir); rm -f *.asy asy*
	-rmdir $(exampledir)
	-cd $(asydir); rm -f *.asy
	-rmdir $(asydir)
	-rm -f $(latexdir)/asymptote.sty
	-rmdir $(latexdir)
	-rm -f $(bindir)/$(NAME) $(bindir)/$(XNAME) 

uninstall-man: 
	cd doc; $(MAKE) uninstall

clean:  FORCE
	rm -f asy *.o *.d *mon.out $(CLEAN)

distclean: FORCE clean
	rm -f Makefile config.h config.log config.status
	cd doc; $(MAKE) distclean

maintainer-clean: FORCE distclean
	rm -f configure config.h.in 
	rm -rf autom4te.cache

test:   asy FORCE
	./wce

.SUFFIXES: .c .cc .o .d
.cc.o:
	$(CXX) $(OPTS) $(INCL) -o $@ -c $<
.cc.d:
	$(CXX) $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@
.c.d:
	$(CC) $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@

FORCE:

configure: configure.ac
	autoheader && autoconf

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

