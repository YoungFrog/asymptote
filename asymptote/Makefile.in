# @configure_input@

ARCH = unix
POLL = poll

LIBS = $(LFLAGS) @LIBS@

CAMP = camperror path drawpath drawlabel picture psfile texfile util settings \
       guide knotlist pathlist drawfill
FILES = $(CAMP) cast env genv main runtime stm dec errormsg inst name symbol \
	types entry exp newexp stack camp.tab lex.yy import access \
	absyn record pool interact fileio builtin fftw++ simpson coder coenv
CLEAN = camp.tab.h camp.tab.cc lex.yy.cc camp.output
NAME = asy
XNAME = x$(NAME)
MANFILES = {asy.1,xasy.1x}

CXX = @CXX@ -Wall -ansi
MAKEDEPEND = $(CXX) $(OPTS) -M -DDEPEND
YACC = @YACC@
LEX = @LEX@

DEFS = @DEFS@
OPT = -g -O3 -DNDEBUG
OPTS = $(OPT) $(DEFS) $(CFLAGS) 
INCL = -I- -I .

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
datadir = @datadir@
asydir = $(datadir)/asymptote
exampledir = $(datadir)/doc/asymptote
latexdir = @latexdir@
INSTALL = @INSTALL@

ASYMPTOTE_DIR = ../base
export ASYMPTOTE_DIR

asy: 	parser depend
	$(MAKE) -f Compile files

all:  	asy man

man:	asy
	cd doc; make man

depend: $(FILES:=.d)

parser: camp.tab.cc camp.tab.h lex.yy.cc

camp.tab.h: camp.tab.cc

camp.tab.cc: camp.y
	$(YACC) -dvt -b camp camp.y
	mv camp.tab.c camp.tab.cc

lex.yy.cc: camp.l
	$(LEX) -d -olex.yy.cc camp.l

lex.yy.d: lex.yy.cc camp.tab.h

install: asy
	${INSTALL} -d $(bindir) $(asydir) $(exampledir) $(latexdir)
	${INSTALL} -s $(NAME) $(bindir)
	${INSTALL} $(XNAME) $(bindir)
	${INSTALL} -m644 base/*.asy $(asydir)
	${INSTALL} -m644 examples/*.asy base/asy* $(exampledir)
	${INSTALL} -m644 doc/asymptote.sty $(latexdir)
	texhash

install-man: man
	${INSTALL} -d $(prefix)/info $(exampledir) $(mandir)/man1
	${INSTALL} -m 644 doc/asymptote.info $(prefix)/info
	install-info --infodir=$(prefix)/info doc/asymptote.info 
	${INSTALL} -m 644 doc/asymptote.pdf $(exampledir)
	${INSTALL} -m 644 doc/$(MANFILES) $(mandir)/man1

install-all: install install-man

uninstall: 
	-cd $(exampledir); rm -f *.asy asy*
	-rmdir $(exampledir)
	-cd $(asydir); rm -f *.asy
	-rmdir $(asydir)
	-rm -f $(latexdir)/asymptote.sty
	-rmdir $(latexdir)
	-rm -f $(bindir)/$(NAME) $(bindir)/$(XNAME) 
	-install-info --delete --infodir=$(prefix)/info doc/asymptote.info
	-rm -f $(prefix)/info/asymptote.info
	-rm -f $(mandir)/man1/$(MANFILES)


clean:  FORCE
	rm -f asy *.o *.d *mon.out $(CLEAN)

distclean: FORCE clean
	rm -f Makefile config.h config.log config.status
	cd doc; make distclean

maintainer-clean: FORCE distclean
	rm -f configure config.h.in 
	rm -rf autom4te.cache

test:   asy FORCE
	./wce

.SUFFIXES: .c .cc .o .d
.cc.o:
	$(CXX) $(OPTS) $(INCL) -o $@ -c $<
.cc.d:
	$(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@

FORCE:

configure: configure.ac
	autoheader && autoconf

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

