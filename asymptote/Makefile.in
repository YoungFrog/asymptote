# @configure_input@

ARCH = unix
POLL = poll

GC = @GCDIR@
GCOPTIONS = @GCOPTIONS@
GCLIB = @GCLIB@
GCPPLIB = @GCPPLIB@
GCLIBS = $(GCPPLIB) $(GCLIB)
LFLAGS = @LDFLAGS@
LIBS = $(LFLAGS) @LIBS@ $(GCLIBS)

CAMP = camperror path drawpath drawlabel picture psfile texfile util settings \
       guide flatguide knot drawfill path3
FILES = $(CAMP) runtime env genv main stm dec errormsg callable name \
	symbol types entry exp newexp stack camp.tab lex.yy access \
	absyn record interact fileio builtin fftw++ simpson coder coenv \
	@getopt@ locate parser program application varinit fundec refaccess \
	Delaunay envcompleter process

DIST = camp.tab.h camp.tab.cc lex.yy.cc runtime.h runtime.cc keywords.cc \
	asy-keywords.el base/asy-keywords.el
CLEAN = camp.output asy.list
NAME = asy
EXTRABIN = x$(NAME)
EXTRA = asy-mode.el asy-keywords.el asy-init.el asy.vim asymptote.py
KEYWORDS = base $(ASYMPTOTE_SITEDIR)
LATEXFILES = asymptote.sty asycolors.sty pdfanim_temp.sty

DEFS = @DEFS@ @OPTIONS@
CFLAGS = @CPPFLAGS@ @CFLAGS@ 
OPTS = $(DEFS) $(CFLAGS)
INCL = -I . @INCL@

CXX = @CXX@ -Wall -ansi
CC = @CC@ -Wall -ansi
MAKEDEPEND = $(OPTS) -O0 -M -DDEPEND
BISON = bison
LEX = @LEX@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(DESTDIR)@bindir@
mandir = $(DESTDIR)@mandir@
infodir = $(DESTDIR)@infodir@
datadir = $(DESTDIR)@datadir@
asydir = $(datadir)/asymptote
docdir = $(DESTDIR)@docdir@
exampledir = $(docdir)/examples
animationsdir = $(exampledir)/animations
latexdir = $(DESTDIR)@latexdir@
INSTALL = @INSTALL@

export prefix docdir exampledir mandir infodir INSTALL MAKE DESTDIR

asy: $(GCLIBS) $(FILES:=.o) 
	$(CXX) $(OPTS) -o $(NAME) $(FILES:=.o) $(LIBS)

msdos: $(GCLIBS) $(FILES:=.o) asy.o
	$(CXX) $(OPTS) -o $(NAME) $(FILES:=.o) asy.o $(LIBS) -s -static

asy.o:	asy.rc asy.ico Makefile
	cat asy.rc | sed -e "s/ASYMPTOTE_VERSION/@VERSION@/" | \
	windres -o asy.o

all:  	asy man faq asy-keywords.el

$(GCLIB): $(GC).tar.gz
	gunzip -c $(GC).tar.gz > $(GC).tar
	tar -xf $(GC).tar
	rm -f $(GC).tar
	if test "$(GC)" = "gc6.8"; then \
	  cd $(GC)/include; patch < ../../patches/gc6.8_AIX.patch; \
	fi
	cd $(GC); \
	./configure $(GCOPTIONS); \
	$(MAKE) check

$(GCPPLIB): $(GCLIB)

html:	asy
	cd doc; $(MAKE) doc

man:	asy
	cd doc; $(MAKE) man

faq:	asy
	cd doc; $(MAKE) faq

runtime.cc: runtime.pl runtime.in
	./runtime.pl

camp.tab.h camp.tab.cc: camp.y
	$(BISON) -dvt -b camp camp.y
	mv camp.tab.c camp.tab.cc

lex.yy.cc: camp.l
	$(LEX) -d -olex.yy.cc camp.l

lex.yy.d: $(GCLIBS) lex.yy.cc camp.tab.h

keywords.cc: keywords.pl camp.l
	./keywords.pl

envcompleter.d: keywords.cc

asy-keywords.el: asy-list.pl 
	./asy -l -dir base > asy.list
	ls $(addsuffix /*.asy,$(KEYWORDS)) | grep -v plain\* | grep -v featpost3D | xargs ./asy -l -dir base >> asy.list
	./asy-list.pl asy.list @VERSION@
	ln -sf ../asy-keywords.el base/

install: install-asy install-man

install-all: install-asy install-doc

install-asy: asy asy-keywords.el
	${INSTALL} -d $(bindir) $(asydir) $(exampledir) $(animationsdir)
	-${INSTALL} -d $(latexdir)
	${INSTALL} -p -m 755 $(NAME) $(EXTRABIN) $(bindir)
	${INSTALL} -p -m 644 base/*.asy $(addprefix base/,$(EXTRA)) $(asydir)
	${INSTALL} -p -m 644 examples/*.asy examples/piicon.eps \
		doc/*.asy doc/*.csv doc/*.dat doc/latexusage.tex $(exampledir)
	${INSTALL} -p -m 644 examples/animations/*.asy $(animationsdir)
	-${INSTALL} -p -m 644 $(addprefix doc/,$(LATEXFILES)) $(latexdir)
	-if test -z "$(DESTDIR)"; then \
	  texhash; \
	fi

install-doc: doc
	cd doc; $(MAKE) install-all

install-man: man
	cd doc; $(MAKE) install

uninstall: uninstall-all

uninstall-all: uninstall-man uninstall-asy

uninstall-asy:
	-cd $(animationsdir); rm -f *.asy
	-rmdir $(animationsdir)
	-cd $(exampledir); rm -f *.asy *.csv *.dat $(EXTRA) piicon.eps \
		latexusage.tex
	-rmdir $(exampledir)
	-rmdir $(docdir)
	-cd $(asydir); rm -f *.asy $(EXTRA)
	-rmdir $(asydir)
	-cd $(latexdir); rm -f $(LATEXFILES)
	-rmdir $(latexdir)
	-cd $(bindir); rm -f $(NAME) $(EXTRABIN)

uninstall-man: 
	cd doc; $(MAKE) uninstall

clean:  FORCE
	rm -f asy *.o *.d *mon.out $(CLEAN)

cleaner: distclean
distclean: FORCE clean
	-if test -d $(GC); then \
		$(MAKE) -C $(GC) distclean; \
		rm -rf $(GC); \
	fi
	rm -f Makefile config.h config.log config.status errors.temp
	cd doc; $(MAKE) distclean
	cd tests; $(MAKE) distclean

cleanest: maintainer-clean
maintainer-clean: FORCE distclean
	rm -f configure config.h.in $(DIST)
	rm -rf autom4te.cache

check: asy FORCE
	./wce
	$(MAKE) -C tests

.SUFFIXES: .c .cc .o .d
.cc.o:
	$(CXX) $(OPTS) $(INCL) -o $@ -c $<
.cc.d:
	@echo Creating $@; \
	rm -f $@; \
	${CXX} $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@.$$$$ 2>/dev/null && \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$
.c.d:
	@echo Creating $@; \
	rm -f $@; \
	${CC} $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@.$$$$ 2>/dev/null && \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$

ifeq (,$(findstring clean,${MAKECMDGOALS}))
-include $(FILES:=.d)
endif

FORCE:

configure: configure.ac
	autoheader && autoconf

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

