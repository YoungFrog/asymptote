# @configure_input@

ARCH = unix
POLL = poll

GC = @GCDIR@
GCLIBS = @GCLIBS@
LIBS = $(LFLAGS) @LIBS@ $(GCLIBS)

CAMP = camperror path drawpath drawlabel picture psfile texfile util settings \
       guide flatguide knot drawfill path3
FILES = $(CAMP) env genv main runtime stm dec errormsg callable name \
	symbol types entry exp newexp stack camp.tab lex.yy access \
	absyn record interact fileio builtin fftw++ simpson coder coenv \
	@getopt@ locate parser genrun program application varinit fundec

DIST = camp.tab.h camp.tab.cc lex.yy.cc genrun.cc
CLEAN = camp.output
NAME = asy
XNAME = x$(NAME)

CXX = @CXX@ -Wall -ansi
CC = @CC@ -Wall -ansi
MAKEDEPEND = $(OPTS) -O0 -M -DDEPEND
BISON = bison
LEX = @LEX@

DEFS = @DEFS@ @OPTIONS@
CFLAGS = @CPPFLAGS@ @CFLAGS@ 
OPTS = $(DEFS) $(CFLAGS) 
INCL = -I . @INCL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
datadir = @datadir@
asydir = $(datadir)/asymptote
docdir = $(datadir)/doc/asymptote
exampledir = $(docdir)
animationsdir = $(exampledir)/animations
latexdir = @latexdir@
INSTALL = @INSTALL@
ASYMPTOTE_DIR = ../base

export prefix docdir exampledir mandir INSTALL ASYMPTOTE_DIR 

# $(MAGIC) is here for when we include Makefile again from Compile
asy$(MAGIC): depend
	$(MAKE) -f Compile asy

msdos$(MAGIC): depend
	$(MAKE) -f Compile CFLAGS="-g -O3 -DMSDOS" LFLAGS="-s -static" msdos

asy.o:	asy.rc asy.ico Makefile
	cat asy.rc | sed -e "s/ASYMPTOTE_VERSION/@VERSION@/" | \
	windres -o asy.o

all:  	asy man

$(GCLIBS): $(GC).tar.gz
	gunzip -c $(GC).tar.gz > $(GC).tar
	tar -xf $(GC).tar
	rm -f $(GC).tar
	cd $(GC); \
	./configure --disable-threads --disable-shared --enable-cplusplus; \
	$(MAKE) check

doc:	asy
	cd doc; $(MAKE) doc

man:	asy
	cd doc; $(MAKE) man

depend: $(GCLIBS) camp.tab.h genrun.cc $(FILES:=.d)

genrun.cc: runtime.pl runtime.in
	./runtime.pl

camp.tab.h: camp.tab.cc

camp.tab.cc: camp.y
	$(BISON) -dvt -b camp camp.y
	mv camp.tab.c camp.tab.cc

lex.yy.cc: camp.l
	$(LEX) -d -olex.yy.cc camp.l

lex.yy.d: lex.yy.cc camp.tab.h

install: install-asy install-man

install-all: install-asy install-doc

install-asy: asy
	${INSTALL} -d $(bindir) $(asydir) $(exampledir) $(animationsdir) \
			$(latexdir)
	${INSTALL} -s $(NAME) $(bindir)
	${INSTALL} $(XNAME) $(bindir)
	${INSTALL} -m644 base/*.asy $(asydir)
	${INSTALL} -m644 examples/*.asy examples/piicon.eps base/asy* \
		doc/*.asy doc/*.csv doc/*.dat doc/latexusage.tex $(exampledir)
	${INSTALL} -m644 examples/animations/*.asy $(animationsdir)
	${INSTALL} -m644 doc/asymptote.sty $(latexdir)
	texhash

install-doc: doc
	cd doc; $(MAKE) install

install-man: man
	cd doc; $(MAKE) install-man

uninstall: uninstall-all

uninstall-all: uninstall-man uninstall-asy

uninstall-asy:
	-cd $(animationsdir); rm -f *.asy
	-rmdir $(animationsdir)
	-cd $(exampledir); rm -f *.asy *.csv *.dat asy* piicon.eps \
		latexusage.tex
	-rmdir $(exampledir)
	-cd $(asydir); rm -f *.asy
	-rmdir $(asydir)
	-rm -f $(latexdir)/asymptote.sty
	-rmdir $(latexdir)
	-rm -f $(bindir)/$(NAME) $(bindir)/$(XNAME) 

uninstall-man: 
	cd doc; $(MAKE) uninstall

clean:  FORCE
	rm -f asy *.o *.d *mon.out $(CLEAN)

cleaner: distclean
distclean: FORCE clean
	-if test -d $(GC); then \
		$(MAKE) -C $(GC) distclean; \
		rm -rf $(GC); \
	fi
	rm -f Makefile config.h config.log config.status; \
	cd doc; $(MAKE) distclean; \

cleanest: maintainer-clean
maintainer-clean: FORCE distclean
	rm -f configure config.h.in $(DIST)
	rm -rf autom4te.cache

check: asy FORCE
	./wce
	$(MAKE) -C tests

.SUFFIXES: .c .cc .o .d
.cc.o:
	$(CXX) $(OPTS) $(INCL) -o $@ -c $<
.cc.d:
	$(CXX) $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@
.c.d:
	$(CC) $(MAKEDEPEND) $(INCL) $(MDOPTS) $< > $@

FORCE:

configure: configure.ac
	autoheader && autoconf

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

